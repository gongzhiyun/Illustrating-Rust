<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="600" viewBox="0 0 800 600" fill="none" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
  <rect width="800" height="600" fill="#f8f9fa"/>
  <!-- Title -->
  <text x="400" y="35" font-family="JetBrains Mono, monospace" font-size="22" font-weight="bold" fill="#333333" text-anchor="middle">迭代器组合子的“三位一体”布局</text>
  <text x="400" y="60" font-family="JetBrains Mono, monospace" font-size="14" fill="#78909c" text-anchor="middle">栈（结构）、堆（数据）、代码段（逻辑）</text>

  <!-- Stack Section -->
  <g transform="translate(150, 100)">
    <text x="75" y="-20" font-family="JetBrains Mono, monospace" font-size="16" font-weight="bold" fill="#2196f3" text-anchor="middle">Stack (栈内存 - 结构)</text>
    
    <!-- Unified Memory Block -->
    <rect x="0" y="0" width="150" height="180" rx="4" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>
    
    <!-- Fields (Physical Memory) -->
    <g font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">
      <text x="10" y="30" font-weight="bold" fill="#ff9800">IntoIter:</text>
      <line x1="5" y1="45" x2="145" y2="45" stroke="#bbdefb" stroke-width="1"/>
      <text x="10" y="70">buf: RawVec</text>
      <text x="10" y="115">ptr: *const T</text>
      <text x="10" y="160">end: *const T</text>
    </g>

    <!-- Lateral Brackets (Offset 0 Nesting) -->
    <!-- Filter Bracket -->
    <path d="M -60 0 L -70 0 L -70 180 L -60 180" stroke="#9c27b0" stroke-width="2" fill="none"/>
    <text x="-85" y="90" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#9c27b0" transform="rotate(-90, -85, 90)" text-anchor="middle">Filter</text>
    
    <!-- Map Bracket -->
    <path d="M -30 0 L -40 0 L -40 180 L -30 180" stroke="#673ab7" stroke-width="1.5" fill="none"/>
    <text x="-45" y="90" font-family="JetBrains Mono, monospace" font-size="12" font-weight="bold" fill="#673ab7" transform="rotate(-90, -45, 90)" text-anchor="middle">Map</text>

    <!-- ZST Closures (Logical Only) -->
    <g transform="translate(0, 180)">
      <line x1="0" y1="0" x2="150" y2="0" stroke="#9c27b0" stroke-width="1.5" stroke-dasharray="3,3"/>
      <text x="75" y="20" font-family="JetBrains Mono, monospace" font-size="11" fill="#9c27b0" text-anchor="middle">f: MapClosure (ZST)</text>
      <text x="75" y="35" font-family="JetBrains Mono, monospace" font-size="11" fill="#9c27b0" text-anchor="middle">pred: FilterClosure (ZST)</text>
    </g>

    <!-- Address Labels -->
    <g font-family="JetBrains Mono, monospace" font-size="10" fill="#78909c">
      <text x="155" y="5" text-anchor="start">Offset +0</text>
      <text x="155" y="185" text-anchor="start">Offset +24</text>
    </g>
  </g>

  <!-- Heap Section -->
  <g transform="translate(500, 100)">
    <text x="100" y="-15" font-family="JetBrains Mono, monospace" font-size="16" font-weight="bold" fill="#4caf50" text-anchor="middle">Heap (堆内存 - 数据)</text>
    <rect x="0" y="0" width="200" height="240" rx="8" fill="#e8f5e9" stroke="#4caf50" stroke-width="2"/>
    <rect x="20" y="30" width="160" height="40" fill="#ffffff" stroke="#4caf50" stroke-width="1"/>
    <text x="100" y="55" font-family="JetBrains Mono, monospace" font-size="14" fill="#333333" text-anchor="middle">1 (i32)</text>
    <rect x="20" y="70" width="160" height="40" fill="#ffffff" stroke="#4caf50" stroke-width="1"/>
    <text x="100" y="95" font-family="JetBrains Mono, monospace" font-size="14" fill="#333333" text-anchor="middle">2 (i32)</text>
    <rect x="20" y="110" width="160" height="40" fill="#ffffff" stroke="#4caf50" stroke-width="1"/>
    <text x="100" y="135" font-family="JetBrains Mono, monospace" font-size="14" fill="#333333" text-anchor="middle">3 (i32)</text>
  </g>

  <!-- Code Segment (Bottom) -->
  <g transform="translate(100, 420)">
    <rect x="0" y="0" width="600" height="100" rx="8" fill="#eceff1" stroke="#546e7a" stroke-width="2"/>
    <text x="300" y="25" font-family="JetBrains Mono, monospace" font-size="16" font-weight="bold" fill="#546e7a" text-anchor="middle">Code Segment (代码段 - 逻辑)</text>
    
    <!-- Map Logic -->
    <rect x="40" y="40" width="240" height="45" rx="4" fill="#ffffff" stroke="#9c27b0" stroke-width="1.5"/>
    <text x="160" y="68" font-family="JetBrains Mono, monospace" font-size="12" fill="#9c27b0" text-anchor="middle">Map Logic: |x| x * 2</text>
    
    <!-- Filter Logic -->
    <rect x="320" y="40" width="240" height="45" rx="4" fill="#ffffff" stroke="#9c27b0" stroke-width="1.5"/>
    <text x="440" y="68" font-family="JetBrains Mono, monospace" font-size="12" fill="#9c27b0" text-anchor="middle">Filter Logic: |x| x &gt; 2</text>
  </g>

  <!-- Connection Arrows -->
  <!-- Stack to Heap (Data Pointers) -->
  <g opacity="0.85">
    <!-- buf pointer: 从 buf 行中心 (300, 170) 到堆内存起始 (515, 130) -->
    <path d="M 300 170 C 360 170, 430 130, 515 130" stroke="#90a4ae" stroke-width="2" fill="none" marker-end="url(#arrowhead-gray)"/>
    <!-- ptr pointer: 从 ptr 行中心 (300, 215) 到堆内存当前数据块中心 (515, 150) -->
    <path d="M 300 215 C 380 215, 450 150, 515 150" stroke="#ff9800" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
    <!-- end pointer: 从 end 行中心 (300, 260) 到堆内存数据末尾 (515, 250) -->
    <path d="M 300 260 C 380 260, 450 250, 515 250" stroke="#ef5350" stroke-width="2" fill="none" marker-end="url(#arrowhead-red)"/>
  </g>
  
  <!-- Stack Closures to Code Segment (Logic Mappings) -->
  <g opacity="0.9">
    <!-- Map closure: 从 f 左侧 (160, 300) 向下弯曲到 Map Logic (160, 455) -->
    <path d="M 160 300 C 120 350, 120 400, 160 455" stroke="#9c27b0" stroke-width="1.2" stroke-dasharray="4,2" fill="none" marker-end="url(#arrowhead-purple)"/>
    <!-- Filter closure: 从 pred 右侧 (300, 315) 向下弯曲到 Filter Logic (440, 455) -->
    <path d="M 300 315 C 340 315, 440 400, 440 455" stroke="#9c27b0" stroke-width="1.2" stroke-dasharray="4,2" fill="none" marker-end="url(#arrowhead-purple)"/>
  </g>

  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#ff9800"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#9c27b0"/>
    </marker>
    <marker id="arrowhead-gray" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#90a4ae"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#ef5350"/>
    </marker>
  </defs>

  <!-- Explanations -->
  <g transform="translate(400, 560)">
    <text x="0" y="0" font-family="JetBrains Mono, monospace" font-size="13" fill="#78909c" text-anchor="middle">※ 闭包字段是 ZST (0 字节)，仅作为编译时的“逻辑索引”</text>
    <text x="0" y="20" font-family="JetBrains Mono, monospace" font-size="13" fill="#78909c" text-anchor="middle">※ 真正的函数体存放在代码段中，通过内联优化彻底消除调用开销</text>
  </g>
</svg>
