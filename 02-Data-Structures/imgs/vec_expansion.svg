<?xml version="1.0" encoding="UTF-8"?>
<svg width="870" height="505" viewBox="0 0 870 505" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
  <!-- Background -->
  <rect width="870" height="505" fill="#f8f9fa" />
  
  <!-- Title -->
  <text x="435" y="35" font-family="JetBrains Mono, monospace" font-size="22" font-weight="bold" text-anchor="middle" fill="#333333">Vec 扩容：栈更新与物理搬迁</text>

  <!-- Main Container -->
  <g transform="translate(30, 70)">
    <rect x="-10" y="-5" width="820" height="385" rx="15" fill="#fff" stroke="#e0e0e0" stroke-width="1.5" />

    <!-- Left Column: Stack -->
    <g transform="translate(20, 20)">
      <rect width="280" height="350" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
      <rect width="280" height="35" rx="12" fill="#e3f2fd" />
      <rect y="20" width="280" height="15" fill="#e3f2fd" />
      <text x="140" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#1565c0" text-anchor="middle">Stack (内存栈)</text>
      
      <!-- Vec Struct -->
      <g transform="translate(15, 60)">
        <rect width="250" height="280" rx="8" fill="#ffffff" stroke="#2196f3" stroke-width="2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#1565c0">Vec&lt;u8&gt; (更新后)</text>

        <!-- ptr field -->
        <g transform="translate(10, 20)">
          <rect width="230" height="45" fill="#fff8e1" stroke="#ff9800" rx="4"/>
          <text x="10" y="20" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#546e7a">ptr</text>
          <text x="10" y="38" font-family="JetBrains Mono, monospace" font-size="9" fill="#f57c00">指向新地址 (0x9000)</text>
          <text x="220" y="28" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#f57c00" text-anchor="end">0x9000</text>
        </g>
        
        <!-- cap field -->
        <g transform="translate(10, 85)">
          <rect width="230" height="45" fill="#ffffff" stroke="#4caf50" stroke-width="1.5" rx="4"/>
          <text x="10" y="20" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#546e7a">cap</text>
          <text x="10" y="38" font-family="JetBrains Mono, monospace" font-size="9" fill="#2e7d32">容量翻倍 (4 -> 8)</text>
          <text x="220" y="28" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#333333" text-anchor="end">8</text>
        </g>
        
        <!-- len field -->
        <g transform="translate(10, 150)">
          <rect width="230" height="45" fill="#ffffff" stroke="#e0e0e0" rx="4"/>
          <text x="10" y="28" font-family="JetBrains Mono, monospace" font-size="11" fill="#546e7a">len</text>
          <text x="220" y="28" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#333333" text-anchor="end">5</text>
        </g>

        <!-- Update Label -->
        <g transform="translate(10, 210)">
          <rect width="230" height="50" rx="4" fill="#fff" stroke="#9c27b0" stroke-dasharray="2 2" />
          <text x="115" y="20" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#6a1b9a" text-anchor="middle">3. 更新栈字段</text>
          <text x="115" y="38" font-family="JetBrains Mono, monospace" font-size="9" fill="#7b1fa2" text-anchor="middle">重定向指针并更新容量</text>
        </g>
      </g>
    </g>

    <!-- Right Column: Heap Sections -->
    <g transform="translate(330, 20)">
      <!-- Old Heap Section -->
      <g transform="translate(0, 0)">
        <rect width="470" height="150" rx="12" fill="#ffffff" stroke="#ef5350" stroke-width="1" />
        <rect width="470" height="35" rx="12" fill="#ffebee" />
        <rect y="20" width="470" height="15" fill="#ffebee" />
        <text x="235" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#c62828" text-anchor="middle">Old Heap (旧内存 - 0x55aa)</text>
        
        <g transform="translate(20, 60)">
          <rect width="50" height="50" fill="#fff" stroke="#ef5350" stroke-width="1.5" rx="4" />
          <rect x="60" width="50" height="50" fill="#fff" stroke="#ef5350" stroke-width="1.5" rx="4" />
          <rect x="120" width="50" height="50" fill="#fff" stroke="#ef5350" stroke-width="1.5" rx="4" />
          <rect x="180" width="50" height="50" fill="#fff" stroke="#ef5350" stroke-width="1.5" rx="4" />
          <!-- Cross Out -->
          <line x1="0" y1="0" x2="230" y2="50" stroke="#ef5350" stroke-width="2" />
          <line x1="0" y1="50" x2="230" y2="0" stroke="#ef5350" stroke-width="2" />
          <text x="260" y="30" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#ef5350">4. 释放旧空间</text>
        </g>
      </g>

      <!-- New Heap Section -->
      <g transform="translate(0, 200)">
        <rect width="470" height="130" rx="12" fill="#ffffff" stroke="#4caf50" stroke-width="1" />
        <rect width="470" height="35" rx="12" fill="#e8f5e9" />
        <rect y="20" width="470" height="15" fill="#e8f5e9" />
        <text x="235" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#2e7d32" text-anchor="middle">New Heap (新内存 - 0x9000)</text>
        
        <g transform="translate(20, 60)">
          <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="10" fill="#2e7d32">1. 申请新空间 (2x 容量)</text>
          <!-- Copied Elements -->
          <rect width="45" height="45" fill="#fff" stroke="#4caf50" stroke-width="2" rx="4" />
          <rect x="55" width="45" height="45" fill="#fff" stroke="#4caf50" stroke-width="2" rx="4" />
          <rect x="110" width="45" height="45" fill="#fff" stroke="#4caf50" stroke-width="2" rx="4" />
          <rect x="165" width="45" height="45" fill="#fff" stroke="#4caf50" stroke-width="2" rx="4" />
          
          <!-- New Element -->
          <rect x="220" width="45" height="45" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2" rx="4" />
          <text x="242.5" y="28" font-family="JetBrains Mono, monospace" font-size="12" font-weight="bold" fill="#2e7d32" text-anchor="middle">New</text>

          <!-- Empty Slots -->
          <rect x="275" width="45" height="45" fill="#f5f5f5" stroke="#bdbdbd" stroke-dasharray="4 2" rx="4" />
          <rect x="330" width="45" height="45" fill="#f5f5f5" stroke="#bdbdbd" stroke-dasharray="4 2" rx="4" />
          <rect x="385" width="45" height="45" fill="#f5f5f5" stroke="#bdbdbd" stroke-dasharray="4 2" rx="4" />
        </g>
      </g>
    </g>

    <!-- Pointers and Connections -->
    <defs>
      <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
        <path d="M0,0 L10,5 L0,10 Z" fill="#9c27b0" />
      </marker>
      <marker id="arrow-orange" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="6" markerHeight="6" markerUnits="userSpaceOnUse" orient="auto">
        <path d="M0,0 L10,5 L0,10 Z" fill="#ff9800" />
      </marker>
      <marker id="arrow-red-dashed" viewBox="0 0 10 10" refX="0" refY="5" markerWidth="6" markerHeight="6" markerUnits="userSpaceOnUse" orient="auto">
        <path d="M0,0 L10,5 L0,10 Z" fill="#ef5350" />
      </marker>
    </defs>
    
    <!-- Old Pointer (Stack to Old Heap) - Dashed -->
    <path d="M 275,122.5 C 310,122.5 310,105 344,105" fill="none" stroke="#ef5350" stroke-width="1.5" stroke-dasharray="3 3" marker-end="url(#arrow-red-dashed)" />
    
    <!-- Copy Arrows (Old to New) -->
    <g transform="translate(350, 140)">
      <path d="M 40,0 L 40,60" fill="none" stroke="#9c27b0" stroke-width="2" stroke-dasharray="4 2" marker-end="url(#arrow-purple)" />
      <path d="M 100,0 L 100,60" fill="none" stroke="#9c27b0" stroke-width="2" stroke-dasharray="4 2" marker-end="url(#arrow-purple)" />
      <text x="150" y="50" font-family="JetBrains Mono, monospace" font-size="12" font-weight="bold" fill="#6a1b9a">2. memcpy (数据搬运)</text>
    </g>
    
    <!-- Pointer Update (Stack to New Heap) -->
    <circle cx="275" cy="122.5" r="3" fill="#ff9800" />
    <path d="M 275,122.5 C 320,122.5 320,302.5 344,302.5" fill="none" stroke="#ff9800" stroke-width="2.5" marker-end="url(#arrow-orange)" />
  </g>

  <!-- Summary Note -->
  <rect x="225" y="455" width="400" height="30" rx="15" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
  <text x="425" y="475" font-family="JetBrains Mono, monospace" font-size="11" fill="#78909c" text-anchor="middle">扩容是 O(n) 的昂贵操作，涉及 申请 -> 拷贝 -> 更新 -> 释放</text>
</svg>
